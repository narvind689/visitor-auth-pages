<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Reset Password</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: #f6f7fb;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
    }

    .card {
      background: white;
      padding: 40px;
      width: 100%;
      max-width: 400px;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }

    h2 {
      text-align: center;
      margin-bottom: 8px;
      color: #1a1a1a;
      font-size: 24px;
    }

    .subtitle {
      text-align: center;
      color: #666;
      font-size: 14px;
      margin-bottom: 32px;
    }

    .input-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-size: 14px;
      font-weight: 500;
      color: #333;
    }

    .password-wrapper {
      position: relative;
      width: 100%;
    }

    input {
      width: 100%;
      padding: 12px 44px 12px 12px;
      border-radius: 8px;
      border: 1px solid #ddd;
      font-size: 14px;
      box-sizing: border-box;
      transition: border-color 0.2s;
    }

    input:focus {
      outline: none;
      border-color: #3f51b5;
    }

    input:disabled {
      background: #f5f5f5;
      cursor: not-allowed;
    }

    .password-wrapper .toggle {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      cursor: pointer;
      font-size: 18px;
      user-select: none;
      opacity: 0.6;
      transition: opacity 0.2s;
    }

    .password-wrapper .toggle:hover {
      opacity: 1;
    }

    .password-strength {
      margin-top: 8px;
      font-size: 12px;
      color: #666;
    }

    .strength-bar {
      height: 4px;
      background: #e0e0e0;
      border-radius: 2px;
      margin-top: 4px;
      overflow: hidden;
    }

    .strength-fill {
      height: 100%;
      width: 0%;
      transition: width 0.3s, background-color 0.3s;
      background: #e0e0e0;
    }

    button {
      width: 100%;
      padding: 14px;
      border-radius: 8px;
      border: none;
      background: #3f51b5;
      color: white;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
      margin-top: 8px;
    }

    button:hover:not(:disabled) {
      background: #303f9f;
    }

    button:disabled {
      background: #aaa;
      cursor: not-allowed;
      opacity: 0.6;
    }

    .spinner {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 0.8s linear infinite;
      margin-right: 8px;
      vertical-align: middle;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .message {
      margin-top: 20px;
      padding: 12px;
      border-radius: 8px;
      font-size: 14px;
      text-align: center;
      display: none;
    }

    .message.show {
      display: block;
    }

    .message.error {
      background: #ffebee;
      color: #c62828;
      border: 1px solid #ef9a9a;
    }

    .message.success {
      background: #e8f5e9;
      color: #2e7d32;
      border: 1px solid #81c784;
    }

    .message.info {
      background: #e3f2fd;
      color: #1565c0;
      border: 1px solid #90caf9;
    }

    .requirements {
      margin-top: 12px;
      font-size: 12px;
      color: #666;
      padding: 12px;
      background: #f9f9f9;
      border-radius: 6px;
    }

    .requirements ul {
      margin: 8px 0 0 0;
      padding-left: 20px;
    }

    .requirements li {
      margin: 4px 0;
    }

    .req-met {
      color: #2e7d32;
    }
  </style>
</head>

<body>

  <div class="card">
    <h2>Reset Your Password</h2>
    <p class="subtitle">Enter your new password below</p>

    <div class="input-group">
      <label for="password">New Password</label>
      <div class="password-wrapper">
        <input 
          id="password" 
          type="password" 
          placeholder="Enter new password"
          autocomplete="new-password"
          disabled
        />
        <span class="toggle" onclick="togglePassword('password', this)">üëÅÔ∏è</span>
      </div>
      <div class="password-strength">
        <div class="strength-bar">
          <div class="strength-fill" id="strengthFill"></div>
        </div>
        <span id="strengthText"></span>
      </div>
    </div>

    <div class="input-group">
      <label for="confirm">Confirm Password</label>
      <div class="password-wrapper">
        <input 
          id="confirm" 
          type="password" 
          placeholder="Confirm new password"
          autocomplete="new-password"
          disabled
        />
        <span class="toggle" onclick="togglePassword('confirm', this)">üëÅÔ∏è</span>
      </div>
    </div>

    <div class="requirements">
      <strong>Password Requirements:</strong>
      <ul>
        <li id="req-length">At least 8 characters</li>
        <li id="req-uppercase">One uppercase letter</li>
        <li id="req-lowercase">One lowercase letter</li>
        <li id="req-number">One number</li>
      </ul>
    </div>

    <button id="updateBtn" type="button" disabled>
      <span id="btnText">Update Password</span>
    </button>

    <div class="message" id="message"></div>
  </div>

  <!-- Supabase JS -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <script>
    // =================================================================
    // üîê SUPABASE CONFIGURATION
    // =================================================================
    // ‚ö†Ô∏è IMPORTANT: Replace these with YOUR actual Supabase credentials
    // Get them from: Supabase Dashboard ‚Üí Project Settings ‚Üí API
    
    const SUPABASE_URL = 'https://rcibtzkjrzawendvhhgd.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJjaWJ0emtqcnphd2VuZHZoaGdkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAzMjYyNTAsImV4cCI6MjA3NTkwMjI1MH0.33A0ihcvF2x7aPHb_X5fY59R7wfRZVzwTcAVQkoswwk';
    
    // Flutter app deep link configuration
    // Set this to your Flutter app's deep link scheme (e.g., 'yourapp://reset-success')
    // Leave as null if you don't have deep linking set up yet
    const FLUTTER_DEEP_LINK = null; // Example: 'visitor2026://password-reset-success'
    
    // Success page fallback if deep link doesn't work or isn't configured
    const SUCCESS_PAGE = 'success.html';

    // =================================================================
    // Initialize Supabase client
    // =================================================================
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const messageEl = document.getElementById('message');
    const btn = document.getElementById('updateBtn');
    const btnText = document.getElementById('btnText');
    const passwordInput = document.getElementById('password');
    const confirmInput = document.getElementById('confirm');

    // =================================================================
    // üéØ MAIN: Initialize Recovery Session
    // =================================================================
    initRecoverySession();

    async function initRecoverySession() {
      console.log('üîÑ Initializing password recovery session...');
      
      showMessage('Verifying your reset link...', 'info');
      
      try {
        const url = window.location.href;
        const params = new URLSearchParams(window.location.search);
        const hashParams = new URLSearchParams(window.location.hash.substring(1));
        
        console.log('üìç Current URL:', url);
        console.log('üìç Query params:', Object.fromEntries(params.entries()));
        console.log('üìç Hash params:', Object.fromEntries(hashParams.entries()));

        let sessionError = null;
        let sessionEstablished = false;

        // Check for token_hash (Magic Link / Email Link flow - RECOMMENDED for password reset)
        if (params.has('token_hash') && params.get('type') === 'recovery') {
          console.log('‚úÖ Detected token_hash recovery flow (Email Link)');
          
          const token_hash = params.get('token_hash');
          const type = params.get('type');
          
          const { data, error } = await supabaseClient.auth.verifyOtp({
            token_hash,
            type: 'recovery',
          });
          
          sessionError = error;
          
          if (data?.session) {
            console.log('‚úÖ Token hash session established:', data.session.user.email);
            sessionEstablished = true;
          }
        }
        // Check for PKCE flow (code parameter)
        else if (params.has('code')) {
          console.log('‚úÖ Detected PKCE flow (code parameter)');
          
          const { data, error } = await supabaseClient.auth.exchangeCodeForSession(url);
          sessionError = error;
          
          if (data?.session) {
            console.log('‚úÖ PKCE session established:', data.session.user.email);
            sessionEstablished = true;
          } else if (error) {
            console.warn('‚ö†Ô∏è PKCE flow failed, this might be due to missing code_verifier');
            console.warn('‚ö†Ô∏è Error details:', error);
          }
        }
        // Check for legacy hash-based flow
        else if (hashParams.has('access_token') || hashParams.has('type')) {
          console.log('‚úÖ Detected legacy hash-based flow');
          
          // For hash-based, we need to call verifyOtp or handle the session from hash
          if (hashParams.get('type') === 'recovery') {
            const access_token = hashParams.get('access_token');
            const refresh_token = hashParams.get('refresh_token');
            
            if (access_token && refresh_token) {
              const { data, error } = await supabaseClient.auth.setSession({
                access_token,
                refresh_token,
              });
              
              sessionError = error;
              
              if (data?.session) {
                console.log('‚úÖ Hash-based session established:', data.session.user.email);
                sessionEstablished = true;
              }
            }
          }
        }
        // No recognized parameters
        else {
          console.error('‚ùå No recovery parameters found in URL');
          throw new Error('Invalid password reset link. No authentication parameters found.');
        }

        // Handle session errors
        if (sessionError) {
          console.error('‚ùå Session error:', sessionError);
          throw sessionError;
        }

        // Verify session was actually created
        const { data: sessionData, error: getSessionError } = await supabaseClient.auth.getSession();
        
        if (getSessionError) {
          console.error('‚ùå Error getting session:', getSessionError);
          throw getSessionError;
        }

        if (!sessionData?.session) {
          console.error('‚ùå No active session found');
          throw new Error('Failed to establish recovery session. Please request a new password reset link.');
        }

        console.log('‚úÖ Session verified successfully');
        console.log('üë§ User email:', sessionData.session.user.email);
        
        // Enable the form
        passwordInput.disabled = false;
        confirmInput.disabled = false;
        btn.disabled = false;
        
        hideMessage();
        
      } catch (error) {
        console.error('‚ùå Recovery session initialization failed:', error);
        
        // Check if this is just a normal page load without parameters
        const params = new URLSearchParams(window.location.search);
        const hashParams = new URLSearchParams(window.location.hash.substring(1));
        const hasAnyParams = params.toString().length > 0 || hashParams.toString().length > 0;
        
        if (!hasAnyParams) {
          // Clean page load, show friendly message
          showMessage('To reset your password, please click the reset link from your email.', 'info');
          btn.disabled = true;
          passwordInput.disabled = true;
          confirmInput.disabled = true;
          return;
        }
        
        let errorMessage = 'Invalid or expired password reset link.';
        
        if (error.message.includes('expired')) {
          errorMessage = 'This password reset link has expired. Please request a new one.';
        } else if (error.message.includes('already been used')) {
          errorMessage = 'This password reset link has already been used. Please request a new one if needed.';
        } else if (error.message) {
          errorMessage = error.message;
        }
        
        showMessage(errorMessage + ' Please request a new password reset from your app.', 'error');
        btn.disabled = true;
        passwordInput.disabled = true;
        confirmInput.disabled = true;
      }
    }

    // =================================================================
    // üîí Password Strength Checker
    // =================================================================
    passwordInput.addEventListener('input', function() {
      const password = this.value;
      const strength = calculatePasswordStrength(password);
      updatePasswordStrength(strength, password);
      updateRequirements(password);
    });

    function calculatePasswordStrength(password) {
      let strength = 0;
      
      if (password.length >= 8) strength += 25;
      if (password.length >= 12) strength += 15;
      if (/[a-z]/.test(password)) strength += 15;
      if (/[A-Z]/.test(password)) strength += 15;
      if (/[0-9]/.test(password)) strength += 15;
      if (/[^a-zA-Z0-9]/.test(password)) strength += 15;
      
      return Math.min(strength, 100);
    }

    function updatePasswordStrength(strength, password) {
      const fill = document.getElementById('strengthFill');
      const text = document.getElementById('strengthText');
      
      fill.style.width = strength + '%';
      
      if (strength === 0 || password.length === 0) {
        fill.style.background = '#e0e0e0';
        text.textContent = '';
      } else if (strength < 40) {
        fill.style.background = '#f44336';
        text.textContent = 'Weak';
      } else if (strength < 70) {
        fill.style.background = '#ff9800';
        text.textContent = 'Fair';
      } else if (strength < 90) {
        fill.style.background = '#2196F3';
        text.textContent = 'Good';
      } else {
        fill.style.background = '#4CAF50';
        text.textContent = 'Strong';
      }
    }

    function updateRequirements(password) {
      const reqs = {
        'req-length': password.length >= 8,
        'req-uppercase': /[A-Z]/.test(password),
        'req-lowercase': /[a-z]/.test(password),
        'req-number': /[0-9]/.test(password)
      };
      
      for (const [id, met] of Object.entries(reqs)) {
        const el = document.getElementById(id);
        if (met) {
          el.classList.add('req-met');
        } else {
          el.classList.remove('req-met');
        }
      }
    }

    // =================================================================
    // üîÑ Update Password Handler
    // =================================================================
    btn.addEventListener('click', updatePassword);

    async function updatePassword() {
      const password = passwordInput.value.trim();
      const confirm = confirmInput.value.trim();

      hideMessage();

      // Validation
      if (!password || !confirm) {
        showMessage('Please fill in both password fields.', 'error');
        return;
      }

      if (password.length < 8) {
        showMessage('Password must be at least 8 characters long.', 'error');
        return;
      }

      if (!/[A-Z]/.test(password)) {
        showMessage('Password must contain at least one uppercase letter.', 'error');
        return;
      }

      if (!/[a-z]/.test(password)) {
        showMessage('Password must contain at least one lowercase letter.', 'error');
        return;
      }

      if (!/[0-9]/.test(password)) {
        showMessage('Password must contain at least one number.', 'error');
        return;
      }

      if (password !== confirm) {
        showMessage('Passwords do not match.', 'error');
        return;
      }

      // Show loading state
      btn.disabled = true;
      btnText.innerHTML = '<span class="spinner"></span>Updating password...';
      passwordInput.disabled = true;
      confirmInput.disabled = true;

      try {
        console.log('üîÑ Attempting to update password...');
        
        const { data, error } = await supabaseClient.auth.updateUser({
          password: password
        });

        if (error) {
          console.error('‚ùå Password update error:', error);
          throw error;
        }

        console.log('‚úÖ Password updated successfully');
        
        showMessage('‚úÖ Password updated successfully! Redirecting to success page...', 'success');
        
        // Sign out to force re-login with new password
        await supabaseClient.auth.signOut();
        
        // Clear the URL parameters to prevent re-initialization
        window.history.replaceState({}, document.title, window.location.pathname);
        
        // Disable form to prevent resubmission
        passwordInput.disabled = true;
        confirmInput.disabled = true;
        
        // Universal deep link attempt - works on all platforms
        attemptAppRedirect();

      } catch (error) {
        console.error('‚ùå Update password failed:', error);
        
        let errorMessage = 'Failed to update password. Please try again.';
        
        if (error.message.includes('session')) {
          errorMessage = 'Your session has expired. Please request a new password reset link.';
        } else if (error.message) {
          errorMessage = error.message;
        }
        
        showMessage(errorMessage, 'error');
        
        // Re-enable form
        btn.disabled = false;
        btnText.textContent = 'Update Password';
        passwordInput.disabled = false;
        confirmInput.disabled = false;
      }
    }

    // =================================================================
    // üëÅÔ∏è Toggle Password Visibility
    // =================================================================
    function togglePassword(inputId, el) {
      const input = document.getElementById(inputId);
      const isPassword = input.type === 'password';
      
      input.type = isPassword ? 'text' : 'password';
      el.textContent = isPassword ? 'üôà' : 'üëÅÔ∏è';
    }

    // =================================================================
    // üí¨ Message Helper Functions
    // =================================================================
    function showMessage(text, type = 'info') {
      messageEl.textContent = text;
      messageEl.className = 'message show ' + type;
    }

    function hideMessage() {
      messageEl.className = 'message';
    }

    // =================================================================
    // üîó Universal Deep Linking (Works on all platforms)
    // =================================================================
    function attemptAppRedirect() {
      // Configure your Flutter app's deep link here
      // For cross-platform support, you can use different schemes:
      // - Custom scheme: 'visitor2026://password-reset-success' (works on all platforms)
      // - Universal link (iOS): 'https://yourdomain.com/reset-success'
      // - App link (Android): 'https://yourdomain.com/reset-success'
      
      // Set your deep link here, or leave null to skip app opening
      const FLUTTER_DEEP_LINK = null; // Example: 'visitor2026://password-reset-success'
      const SUCCESS_PAGE_URL = 'success.html'; // Fallback success page
      
      if (!FLUTTER_DEEP_LINK) {
        // No deep link - redirect to success page after delay
        console.log('‚ÑπÔ∏è No deep link configured. Redirecting to success page...');
        setTimeout(() => {
          window.location.href = SUCCESS_PAGE_URL;
        }, 2000);
        return;
      }
      
      console.log('üîó Attempting to open app with deep link:', FLUTTER_DEEP_LINK);
      
      // Track if app opened successfully
      let appOpened = false;
      
      // Method 1: Hidden iframe (works on iOS)
      const iframe = document.createElement('iframe');
      iframe.style.display = 'none';
      iframe.src = FLUTTER_DEEP_LINK;
      document.body.appendChild(iframe);
      
      // Method 2: Direct navigation (works on Android)
      setTimeout(() => {
        window.location.href = FLUTTER_DEEP_LINK;
      }, 500);
      
      // Method 3: Detect if app opened by checking visibility
      const checkAppOpened = () => {
        // If page becomes hidden, app likely opened
        if (document.hidden || !document.hasFocus()) {
          console.log('‚úÖ App appears to have opened!');
          appOpened = true;
        }
      };
      
      document.addEventListener('visibilitychange', checkAppOpened);
      window.addEventListener('blur', checkAppOpened);
      
      // Fallback: After 3 seconds, if app didn't open, redirect to success page
      setTimeout(() => {
        document.removeEventListener('visibilitychange', checkAppOpened);
        window.removeEventListener('blur', checkAppOpened);
        
        if (!appOpened && document.hasFocus()) {
          console.log('‚ÑπÔ∏è App did not open. Redirecting to success page...');
          window.location.href = SUCCESS_PAGE_URL;
        } else {
          console.log('‚úÖ App opened successfully or user navigated away');
        }
        
        // Clean up iframe
        if (iframe.parentNode) {
          iframe.parentNode.removeChild(iframe);
        }
      }, 3000);
    }

    // =================================================================
    // üîç Debug: Log auth state changes
    // =================================================================
    supabaseClient.auth.onAuthStateChange((event, session) => {
      console.log('üîî Auth state changed:', event, session?.user?.email || 'No user');
    });
  </script>

</body>
</html>
