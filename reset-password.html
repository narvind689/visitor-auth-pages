<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Reset Password</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- ‚úÖ UI unchanged -->
  <style>
    /* === YOUR ORIGINAL CSS (UNCHANGED) === */
    body { margin:0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;background:#f6f7fb;display:flex;align-items:center;justify-content:center;min-height:100vh;padding:20px;}
    .card{background:white;padding:40px;width:100%;max-width:400px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,0.1);}
    h2{text-align:center;margin-bottom:8px;color:#1a1a1a;font-size:24px;}
    .subtitle{text-align:center;color:#666;font-size:14px;margin-bottom:32px;}
    .input-group{margin-bottom:20px;}
    label{display:block;margin-bottom:8px;font-size:14px;font-weight:500;color:#333;}
    .password-wrapper{position:relative;width:100%;}
    input{width:100%;padding:12px 44px 12px 12px;border-radius:8px;border:1px solid #ddd;font-size:14px;box-sizing:border-box;transition:border-color 0.2s;}
    input:focus{outline:none;border-color:#3f51b5;}
    input:disabled{background:#f5f5f5;cursor:not-allowed;}
    .password-wrapper .toggle{position:absolute;right:12px;top:50%;transform:translateY(-50%);cursor:pointer;font-size:18px;user-select:none;opacity:0.6;}
    button{width:100%;padding:14px;border-radius:8px;border:none;background:#3f51b5;color:white;font-size:16px;font-weight:500;cursor:pointer;margin-top:8px;}
    button:disabled{background:#aaa;cursor:not-allowed;opacity:0.6;}
    .message{margin-top:20px;padding:12px;border-radius:8px;font-size:14px;text-align:center;display:none;}
    .message.show{display:block;}
    .message.error{background:#ffebee;color:#c62828;border:1px solid #ef9a9a;}
    .message.success{background:#e8f5e9;color:#2e7d32;border:1px solid #81c784;}
    .message.info{background:#e3f2fd;color:#1565c0;border:1px solid #90caf9;}
  </style>
</head>

<body>

  <!-- ‚úÖ UI unchanged -->
  <div class="card">
    <h2>Reset Your Password</h2>
    <p class="subtitle">Enter your new password below</p>

    <div class="input-group">
      <label for="password">New Password</label>
      <div class="password-wrapper">
        <input id="password" type="password" disabled />
        <span class="toggle" onclick="togglePassword('password', this)">üëÅÔ∏è</span>
      </div>
    </div>

    <div class="input-group">
      <label for="confirm">Confirm Password</label>
      <div class="password-wrapper">
        <input id="confirm" type="password" disabled />
        <span class="toggle" onclick="togglePassword('confirm', this)">üëÅÔ∏è</span>
      </div>
    </div>

    <button id="updateBtn" disabled>
      <span id="btnText">Update Password</span>
    </button>

    <div class="message" id="message"></div>
  </div>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <script>
    const SUPABASE_URL = 'https://rcibtzkjrzawendvhhgd.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJjaWJ0emtqcnphd2VuZHZoaGdkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAzMjYyNTAsImV4cCI6MjA3NTkwMjI1MH0.33A0ihcvF2x7aPHb_X5fY59R7wfRZVzwTcAVQkoswwk';
    const SUCCESS_PAGE = 'success.html';

    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const messageEl = document.getElementById('message');
    const btn = document.getElementById('updateBtn');
    const btnText = document.getElementById('btnText');
    const passwordInput = document.getElementById('password');
    const confirmInput = document.getElementById('confirm');

    initRecoverySession();

    async function initRecoverySession() {
      try {
        const params = new URLSearchParams(window.location.search);

        if (!params.has('token_hash') || params.get('type') !== 'recovery') {
          throw new Error('Invalid or expired password reset link.');
        }

        const token_hash = params.get('token_hash');

        const { data, error } = await supabaseClient.auth.verifyOtp({
          token_hash,
          type: 'recovery',
        });

        if (error) throw error;
        if (!data?.session) throw new Error('Failed to establish recovery session.');

        // Enable form
        passwordInput.disabled = false;
        confirmInput.disabled = false;
        btn.disabled = false;
        hideMessage();

      } catch (error) {
        showMessage(
          (error.message || 'Invalid or expired password reset link.') +
          ' Please request a new password reset from your app.',
          'error'
        );
        btn.disabled = true;
        passwordInput.disabled = true;
        confirmInput.disabled = true;
      }
    }

    btn.addEventListener('click', updatePassword);

    async function updatePassword() {
      const password = passwordInput.value.trim();
      const confirm = confirmInput.value.trim();

      if (!password || !confirm) {
        showMessage('Please fill in both password fields.', 'error');
        return;
      }

      if (password !== confirm) {
        showMessage('Passwords do not match.', 'error');
        return;
      }

      btn.disabled = true;
      btnText.textContent = 'Updating...';

      try {
        const { error } = await supabaseClient.auth.updateUser({ password });
        if (error) throw error;

        await supabaseClient.auth.signOut();
        window.location.href = SUCCESS_PAGE;

      } catch (error) {
        showMessage(error.message || 'Failed to update password.', 'error');
        btn.disabled = false;
        btnText.textContent = 'Update Password';
      }
    }

    function togglePassword(inputId, el) {
      const input = document.getElementById(inputId);
      input.type = input.type === 'password' ? 'text' : 'password';
    }

    function showMessage(text, type) {
      messageEl.textContent = text;
      messageEl.className = 'message show ' + type;
    }

    function hideMessage() {
      messageEl.className = 'message';
    }
  </script>

</body>
</html>